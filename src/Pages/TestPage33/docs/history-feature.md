# 画布编辑器 - 历史记录功能说明

## 概述

历史记录功能支持用户对画布操作进行**撤销（Undo）**和**重做（Redo）**，帮助用户在编辑过程中快速回退错误操作或恢复已撤销的内容。

---

## 快捷键

| 操作 | 快捷键 |
|------|--------|
| 撤销 | `Ctrl + Z` |
| 重做 | `Ctrl + Y` 或 `Ctrl + Shift + Z` |

---

## 支持的元素类型

| 元素类型 | 说明 |
|----------|------|
| 矩形框 | 通过绘制模式创建的矩形标注框 |
| 图片 | 上传到画布的图片对象 |
| 标记点 | 在目标对象上 Ctrl+点击 创建的点标记 |
| 区域框 | 在区域选择模式下拖拽绘制的区域标记 |

---

## 各元素支持的历史操作

### 矩形框

| 操作 | 是否记录历史 | 说明 |
|------|-------------|------|
| 绘制创建 | ✅ | 在绘制模式下完成矩形绘制后记录 |
| 删除 | ✅ | 删除矩形时记录，撤销可恢复 |
| 复制 | ✅ | 复制矩形时记录，撤销会删除复制出的矩形 |
| 移动位置 | ✅ | 拖拽移动完成后记录（拖拽过程中不记录） |
| 缩放大小 | ✅ | 通过控制手柄调整大小完成后记录 |
| 旋转角度 | ✅ | 旋转操作完成后记录 |
| 多选批量操作 | ✅ | 同时选中多个矩形进行移动/缩放/旋转，记录为一条历史 |

### 图片

| 操作 | 是否记录历史 | 说明 |
|------|-------------|------|
| 上传添加 | ✅ | 图片添加到画布后记录 |
| 删除 | ✅ | 删除图片时记录，撤销可恢复图片及其关联的标记 |
| 复制 | ✅ | 复制图片时记录，撤销会删除复制出的图片 |
| 移动位置 | ✅ | 拖拽移动完成后记录 |
| 缩放大小 | ✅ | 通过控制手柄调整大小完成后记录 |
| 旋转角度 | ✅ | 旋转操作完成后记录 |
| 多选批量操作 | ✅ | 同时选中多个图片进行移动/缩放/旋转，记录为一条历史 |

### 标记点

| 操作 | 是否记录历史 | 说明 |
|------|-------------|------|
| 创建标记点 | ✅ | Ctrl+点击 在目标对象上创建标记点后记录 |
| 删除标记点 | ✅ | 单独删除标记点时记录 |
| 跟随目标移动 | ❌ | 标记点跟随目标对象移动时不单独记录（目标对象的移动会记录） |

### 区域框

| 操作 | 是否记录历史 | 说明 |
|------|-------------|------|
| 绘制创建 | ✅ | 在区域选择模式下拖拽绘制完成后记录 |
| 删除区域框 | ✅ | 单独删除区域框时记录 |
| 跟随目标移动 | ❌ | 区域框跟随目标对象移动时不单独记录 |

---

## 特殊场景说明

### 1. 删除目标对象时的关联处理

当删除一个矩形框或图片时：
- 该对象上的所有**标记点**和**区域框**会被一并保存到历史记录中
- 撤销删除操作时，目标对象及其关联的标记点、区域框会**一起恢复**

### 2. 多选操作详解

#### 多选移动/缩放/旋转
- 同时选中多个元素进行变换操作
- 所有被选中元素的变换记录为**一条历史记录**
- 撤销时**一次性恢复**所有元素到变换前的状态
- 支持混合选择（同时选中矩形框和图片）

#### 多选删除
- 同时选中多个元素进行删除
- **按元素类型分别记录**：矩形框记录一条、图片记录一条
- 撤销时需要多次撤销才能恢复所有元素
- 每个被删除元素的关联标记会一并保存和恢复

#### 多选复制
- 同时选中多个元素进行复制
- **按元素类型分别记录**：复制的矩形框记录一条、复制的图片记录一条
- 撤销时删除复制出的元素

### 3. 拖拽过程中的记录策略

- **只记录最终状态**：拖拽/缩放/旋转过程中的中间状态不会记录
- 操作开始时保存初始状态，操作完成后保存最终状态
- 这样可以避免历史记录过多，同时保证撤销时能准确恢复到操作前的状态

### 4. 撤销/重做时的选中状态

- 执行撤销或重做操作时，当前选中的元素会被**自动取消选中**
- 这是为了避免选中状态与实际画布状态不一致

---

## 配置项

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| maxRecords | 50 | 历史记录最大条数，超出后自动删除最早的记录 |

---

## 事件通知

系统会在以下时机派发事件，供 UI 层监听更新状态：

| 事件名 | 触发时机 | 数据 |
|--------|----------|------|
| `history:change` | 历史记录状态变化时 | `{ canUndo: boolean, canRedo: boolean }` |
| `history:undo:before` | 撤销操作执行前 | 当前历史记录 |
| `history:undo:after` | 撤销操作执行后 | 当前历史记录 |
| `history:redo:before` | 重做操作执行前 | 当前历史记录 |
| `history:redo:after` | 重做操作执行后 | 当前历史记录 |

---

## 不支持的操作（暂不记录历史）

以下操作目前不会记录到历史中：

- 画布缩放（zoom）
- 画布平移（pan）
- 元素层级调整（置顶/置底）
- 样式修改（颜色、边框等）

---

## 使用示例

### 典型操作流程

1. 用户绘制一个矩形框 → 记录「添加矩形」
2. 用户移动矩形位置 → 记录「修改矩形」
3. 用户在矩形上添加标记点 → 记录「添加标记点」
4. 用户按 `Ctrl+Z` → 撤销标记点，矩形保持移动后的位置
5. 用户按 `Ctrl+Z` → 撤销移动，矩形回到原位置
6. 用户按 `Ctrl+Y` → 重做移动，矩形回到移动后的位置
